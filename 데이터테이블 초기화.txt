-- 외래 키 제약 조건 삭제 (제약 조건 이름 확인 필요)
ALTER TABLE Receipt DROP CONSTRAINT fk_vehicle;
ALTER TABLE StoreDiscount DROP CONSTRAINT fk_vehicle_discount;

-- 테이블 드롭 (순서 조정)
DROP TABLE StoreDiscount CASCADE CONSTRAINTS;
DROP TABLE Receipt CASCADE CONSTRAINTS;
DROP TABLE Vehicle CASCADE CONSTRAINTS;
DROP TABLE ParkingSpot CASCADE CONSTRAINTS;

-- 시퀀스 드롭
DROP SEQUENCE ReceiptSeq;

-- 주차 공간 테이블
CREATE TABLE ParkingSpot (
    spot_number NUMBER PRIMARY KEY,           -- 주차 공간 번호, PK로 사용
    is_disabled NUMBER(1) DEFAULT 0,          -- 장애인 전용 주차 공간 여부 (기본값: 0)
    is_occupied NUMBER(1) DEFAULT 0,          -- 주차 공간 점유 여부 (기본값: 0)
    vehicle_number VARCHAR2(10) UNIQUE        -- 차량 번호 (고유값으로 설정)
);

-- 차량 테이블
CREATE TABLE Vehicle (
    vehicle_number VARCHAR2(10) PRIMARY KEY,  -- 차량 번호를 기본 키로 설정
    vehicle_type VARCHAR2(10) CHECK (vehicle_type IN ('Standard', 'Compact')) -- 차량 타입 (일반차량, 경차)
);

-- 영수증 테이블
CREATE TABLE Receipt (
    receipt_id NUMBER PRIMARY KEY,            -- 영수증 고유 ID, 시퀀스로 자동 증가
    vehicle_number VARCHAR2(10) NOT NULL,     -- 차량 번호 (외래 키)
    parking_fee_before_discount NUMBER NOT NULL, -- 할인 전 주차 요금
    discount_amount NUMBER DEFAULT 0,         -- 할인 금액 (기본값: 0)
    total_fee NUMBER NOT NULL,                -- 최종 요금 (할인 후)
    parking_duration NUMBER NOT NULL,         -- 주차 시간 (분 단위)
    start_time DATE,                          -- 입차 시간
    end_time DATE,                            -- 출차 시간, NULL 허용
    CONSTRAINT fk_vehicle FOREIGN KEY (vehicle_number) REFERENCES Vehicle(vehicle_number)
);

-- 영수증 ID를 자동 증가시키기 위한 시퀀스 생성
CREATE SEQUENCE ReceiptSeq START WITH 1 INCREMENT BY 1;

-- 세션 내 기본 날짜 형식을 설정하여 시/분/초까지 포함하도록 변경
ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS';

-- 스토어 할인 테이블
CREATE TABLE StoreDiscount (
    store_name VARCHAR2(50) PRIMARY KEY,      -- 스토어 이름, PK로 사용
    discount_percentage NUMBER DEFAULT 0,    -- 할인율 (기본값: 0)
    discount_condition NUMBER NOT NULL,      -- 할인 적용 조건
    vehicle_number VARCHAR2(10),             -- 차량 번호 (Vehicle 테이블과 연동)
    CONSTRAINT fk_vehicle_discount FOREIGN KEY (vehicle_number) REFERENCES Vehicle(vehicle_number)
);

-- 주차 공간 초기화 데이터 삽입: 1~25번은 일반, 26~30번은 장애인 공간으로 설정
BEGIN
    FOR i IN 1..25 LOOP
        INSERT INTO ParkingSpot (spot_number, is_disabled) VALUES (i, 0);
    END LOOP;
    FOR i IN 26..30 LOOP
        INSERT INTO ParkingSpot (spot_number, is_disabled) VALUES (i, 1);
    END LOOP;
END;
/
